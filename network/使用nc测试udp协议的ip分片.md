# 使用nc测试UDP协议的ip分片

测试通发现nc最大传输长度为4096字节，每个UDP包的大小为2048字节，下面是测试例子：

```
nc server 端命令：
nc -lu 2000

nc client 端命令：
nc -u 10.67.15.8 2000
```

然后从server端或者cient端输入4096个字节，这里最大只能输入4096字节，在client端抓包，这包命令如下：

```
tcpdump -i any -nn  ip host 10.67.15.8 -vvvv -s 53 -X
```

抓包结果如下，为了方便说明，我给每个包添加了序号：

```
1. 01:13:40.547055 IP (tos 0x0, ttl 62, id 19176, offset 0, flags [+], proto UDP (17), length 1500)
    10.67.15.8.2000 > 10.67.21.201.56203: UDP, length 2048
	0x0000:  4500 05dc 4ae8 2000 3e11 d2d2 0a43 0f08  E...J...>....C..
	0x0010:  0a43 15c9 07d0 db8b 0808 03db            .C..........
2. 01:13:40.547084 IP (tos 0x0, ttl 62, id 19176, offset 1480, flags [none], proto UDP (17), length 596)
    10.67.15.8 > 10.67.21.201: udp
	0x0000:  4500 0254 4ae8 00b9 3e11 f5a1 0a43 0f08  E..TJ...>....C..
	0x0010:  0a43 15c9 7265 706f 7365 6420            .C..reposed.
3. 01:13:40.547639 IP (tos 0x0, ttl 62, id 19177, offset 0, flags [+], proto UDP (17), length 1500)
    10.67.15.8.2000 > 10.67.21.201.56203: UDP, length 2048
	0x0000:  4500 05dc 4ae9 2000 3e11 d2d1 0a43 0f08  E...J...>....C..
	0x0010:  0a43 15c9 07d0 db8b 0808 05f5            .C..........
4. 01:13:40.547654 IP (tos 0x0, ttl 62, id 19177, offset 1480, flags [none], proto UDP (17), length 596)
    10.67.15.8 > 10.67.21.201: udp
	0x0000:  4500 0254 4ae9 00b9 3e11 f5a0 0a43 0f08  E..TJ...>....C..
	0x0010:  0a43 15c9 652e 7265 706f 7365            .C..e.repose
```

可以看到一共收到4 被分片ip包，两个UDP的包，其中1，2两个分片是同一个UDP包，id都为19176。第一个分片转送的UDP数据长度为1500-20=1480。这里有意思的是第七字节的前四位被设置为0010，也就是MF位被值为1，说明这个ip包被分片了，并且这个包不是最后一个分片。

第二个分片的id都为19176，offset为1480，第七字节的前四位被设置为0000，说明这已经是最后一个分片了。这个一个分片UDP数据长度为596-20=576，两个分片合起来UDP数据包大小为1480+576=2056，去掉UDP头部，数据大小为2048。